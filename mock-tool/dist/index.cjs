(function(L,E){typeof exports=="object"&&typeof module!="undefined"?E(exports,require("localforage")):typeof define=="function"&&define.amd?define(["exports","localforage"],E):(L=typeof globalThis!="undefined"?globalThis:L||self,E(L.mockTools={},L.i))})(this,function(L,E){"use strict";function $(t){return t&&typeof t=="object"&&"default"in t?t.default:t}const H=$(E),J=window.XMLHttpRequest;function W(){const t=process.env.NODE_ENV==="development";let e="pro";return t&&(e="dev"),e}function x(t){return Object.prototype.toString.call(t)==="[object String]"}function B(t){return Object.prototype.toString.call(t)==="[object RegExp]"}function O(t,e){return x(t)?B(e)?e.test(t):typeof e=="string"?t.indexOf(e)!==-1:!1:!1}const D=t=>{let e=t.split("?");return e[0].indexOf("//")>-1?e[0].split("//")[1]:e[0]},R=(t,e,s)=>!(e!=null&&e.length&&!e.some(r=>O(t,r))||s!=null&&s.length&&s.some(r=>O(t,r)));function K(t){const e=new J,s=t._openArgs;e.open(s.method,s.url,s.async,s.username,s.password),t._requestHeaders&&t._requestHeaders.forEach(({value:l,name:i})=>{e.setRequestHeader(i,l)}),["timeout","withCredentials","responseType","msCaching","mimeType"].forEach(l=>{if(t[l]!==void 0)try{e[l]=t[l]}catch(i){console.warn(`Failed to copy property ${l}:`,i)}});const r=["abort","error","load","loadend","loadstart","progress","readystatechange","timeout"];return r.forEach(l=>{const i=t[`on${l}`];typeof i=="function"&&(e[`on${l}`]=i.bind(e))}),t._events&&Object.entries(t._events).forEach(([l,i])=>{i.forEach(({listener:a,options:d})=>{e.addEventListener(l,a.bind(e),d)})}),t.upload&&r.forEach(l=>{const i=t.upload[`on${l}`];typeof i=="function"&&(e.upload[`on${l}`]=i.bind(e.upload))}),e}const b=({url:t,mockUrl:e,mockData:s})=>{e?(console.groupCollapsed(`%cMatched XHR Response modified\uFF1A${t}`,"background-color: #108ee9; color: white; padding: 4px"),console.info("%cModified Request Url\uFF1A","background-color: #ff5500; color: white;",e)):(console.groupCollapsed(`%cMatched XHR Response modified\uFF1A${t}`,"background-color: #108ee9; color: white; padding: 4px"),console.info("%cOriginal Request Url\uFF1A","background-color: #ff8040; color: white;",t),console.info("%cModified Response Payload\uFF1A","background-color: #ff5500; color: white;",JSON.parse(s||null))),console.groupEnd()};function _(t){let e=typeof t=="string"?t:t.toString();return e.startsWith("//")?`${location.protocol}${e}`:e.startsWith("/")?`${location.origin}${e}`:e.startsWith("http")?e:new URL(e,location.href).href}const G=t=>{try{const e=document.createElement("script");e.src=t,e.onerror=function(){console.error("\u52A0\u8F7Dmock-sdk\u5931\u8D25")},e.onload=function(){console.info("\u52A0\u8F7Dmock-sdk\u6210\u529F"),setTimeout(()=>{const s=new CustomEvent("mock-sdk-loaded",{detail:!0});window.dispatchEvent(s)},100)},document.getElementsByTagName("body")[0].appendChild(e)}catch(e){console.error(`mock-sdk\u52A0\u8F7D\u5931\u8D25, ${e.message}`)}},V=()=>{const t='<div id="mock-tool-web"></div>',e=document.createElement("div");e.innerHTML=t,document.getElementsByTagName("body")[0].appendChild(e)},z=t=>{typeof window!="undefined"&&(V(),G(t))};var Q=(t,e,s)=>new Promise((r,l)=>{var i=n=>{try{d(s.next(n))}catch(u){l(u)}},a=n=>{try{d(s.throw(n))}catch(u){l(u)}},d=n=>n.done?r(n.value):Promise.resolve(n.value).then(i,a);d((s=s.apply(t,e)).next())});class Y{constructor(e={}){this.expire=e.expire||0;try{this.store=H.createInstance(Object.assign({name:"common_store",driver:[H.INDEXEDDB,H.LOCALSTORAGE]},e))}catch(s){console.log(s)}}setItem(e,s,r=this.expire){return r&&(r=Date.now()+r*24*60*60*1e3),this.store.setItem(e,{value:s,expire:r}).then(l=>l.value)}getItem(e){return this.store.getItem(e).then(s=>{if(!s)return null;const{value:r,expire:l}=s;return l&&l<Date.now()?this.removeItem(e).then(()=>null):r})}removeItem(e){return this.store.removeItem(e)}clear(){return this.store.clear()}clearExpired(){return Q(this,null,function*(){const e=yield this.keys();return Promise.all(e.map(s=>new Promise((r,l)=>{this.getItem(s).then(r).catch(l)}))).then(()=>{})})}length(){return this.store.length()}keys(){return this.store.keys()}}var Z=(t,e,s)=>new Promise((r,l)=>{var i=n=>{try{d(s.next(n))}catch(u){l(u)}},a=n=>{try{d(s.throw(n))}catch(u){l(u)}},d=n=>n.done?r(n.value):Promise.resolve(n.value).then(i,a);d((s=s.apply(t,e)).next())});const ee=XMLHttpRequest.prototype.open,te=XMLHttpRequest.prototype.send,j=XMLHttpRequest.prototype.setRequestHeader,F=XMLHttpRequest.prototype.addEventListener,P=window.fetch,c={},M={},A={},I=new WeakMap;let w=!1;const q=t=>{const{requestListData:e,rules:s,excludeRules:r,sdkLoaded:l}=t;let i=Object.entries(e).map(a=>a[1]);if(s!=null&&s.length&&(i=i.filter(a=>s.some(d=>O(a.url,d)))),r!=null&&r.length&&(i=i.filter(a=>r.every(d=>!O(a.url,d)))),i.length)if(l){const a=new CustomEvent("mock-request-end",{detail:i.filter(d=>d.url)});window.dispatchEvent(a)}else i.forEach(a=>{A[a.url]=a})},oe=()=>{XMLHttpRequest.prototype.open=ee,XMLHttpRequest.prototype.send=te,XMLHttpRequest.prototype.addEventListener=F,XMLHttpRequest.prototype.setRequestHeader=j,window.fetch=P},N=t=>c[t]&&c[t].activeType==1?c[t].data:null,S=(t,e)=>{if(M[t]=!0,!e)return;const s=new CustomEvent("mock-request-effect",{detail:t});window.dispatchEvent(s),delete M[t]},C=t=>Z(void 0,null,function*(){const e=XMLHttpRequest.prototype.open,s=XMLHttpRequest.prototype.send,{rules:r=[],excludeRules:l=[]}=t||{},i=[...l,/hot-update/,/umiui/,/dev-server/,/devScripts/,/umi/,/undefined/,/localhost/,/favicon\.ico/];((yield new Y().getItem("mock-requestList"))||[]).forEach(n=>{n.isOpen&&(c[n.url]=n)});let a={};const d=({url:n,data:u,status:o,updateData:h})=>{a[n].data=u,a[n].status=o,a[n].updateData=h||u};XMLHttpRequest.prototype.send=function(...n){var u;const o=this,h=this.onreadystatechange,p=D(o.originRequestUrl),f=c[p]&&c[p].isOpen;if(I.get(o))return s.apply(o,n);if(this.onreadystatechange=function(...g){if(this.readyState===this.DONE){if(this.responseType==="text"||this.responseType===""?this.originResponse=this.responseText:this.originResponse=this.response,f&&c[p].activeType==1&&c[p].isWaitResponse){const m=N(p);Object.defineProperties(o,{readyState:{get:()=>4,configurable:!0},status:{get:()=>200,configurable:!0},response:{get:()=>m||this.originResponse,configurable:!0},responseText:{get:()=>m||this.originResponse,configurable:!0},statusText:{get:()=>"OK",configurable:!0}}),b({url:p,mockData:m})}p&&a[p]&&R(p,r,i)&&(!f||c[p].isWaitResponse)&&(d({url:p,data:x(o.response)?o.response:JSON.stringify(o.response),status:f?200:o.status,updateData:x(o.originResponse)?o.originResponse:JSON.stringify(o.originResponse)}),q({requestListData:a,rules:r,excludeRules:i,sdkLoaded:w}),delete a[p])}typeof h=="function"&&h.apply(this,g)},f&&((u=c[p])==null?void 0:u.activeType)==1){const g=N(p);if(c[p].isWaitResponse)this.onerror=function(){Object.defineProperties(o,{readyState:{get:()=>4,configurable:!0},status:{get:()=>200,configurable:!0},response:{get:()=>g,configurable:!0},responseText:{get:()=>typeof g=="string"?g:JSON.stringify(g),configurable:!0},statusText:{get:()=>"OK",configurable:!0}});const m=new Event("load");this.dispatchEvent(m)},s.apply(this,n);else{const m=K(o);I.set(m,!0),m.send(n),m.onreadystatechange=function(){if(m.readyState===m.DONE){const y=m.responseType==="text"||m.responseType===""?m.responseText:m.response;p&&a[p]&&R(p,r,i)&&(d({url:p,data:x(g)?g:JSON.stringify(g),status:m.status,updateData:x(y)?y:JSON.stringify(y)}),q({requestListData:a,rules:r,excludeRules:i,sdkLoaded:w}),delete a[p])}},setTimeout(()=>{Object.defineProperties(o,{readyState:{get:()=>4,configurable:!0},status:{get:()=>200,configurable:!0},response:{get:()=>g,configurable:!0},responseText:{get:()=>typeof g=="string"?g:JSON.stringify(g),configurable:!0},statusText:{get:()=>"OK",configurable:!0}}),o.onreadystatechange&&o.onreadystatechange(),o.onload&&o.onload(),["loadstart","load","loadend"].forEach(X=>{const v=new Event(X);o.dispatchEvent(v)});const y=new Event("readystatechange");o.dispatchEvent(y),b({url:p,mockData:g})},0)}}else s.apply(this,n)},XMLHttpRequest.prototype.open=function(n,u,...o){const h=Array.from(arguments),p=this,f=D(_(u)),g={url:f,method:n,status:p.status,effectLocation:location.href.split("?")[0]};f&&R(f,r,i)&&(a[f]=g);const m=c[f]&&c[f].isOpen;this.originRequestUrl=f,m&&c[f]&&(c[f].activeType==2&&c[f].mockUrl&&(h[1]="//"+c[f].mockUrl,b({url:f,mockUrl:c[f].mockUrl})),S(f,w)),this._openArgs={method:n,url:u,async:o[0],username:o[1],password:o[2]},this._events=this._events||{},e.apply(this,h)},XMLHttpRequest.prototype.addEventListener=function(n,u,o){return this._events=this._events||{},this._events[n]=this._events[n]||[],this._events[n].push({listener:u,options:o}),F.apply(this,arguments)},XMLHttpRequest.prototype.setRequestHeader=function(n,u){return this._requestHeaders||(this._requestHeaders=[]),this._requestHeaders.push({name:n,value:u}),j.apply(this,arguments)},window.fetch=function(n,u){let o="";n&&(typeof n=="string"?o=D(_(n)):typeof n=="object"&&n instanceof Request&&(o=D(_(n.url))),R(o,r,i)&&(a[o]={method:(u==null?void 0:u.method)||"GET",effectLocation:location.href.split("?")[0],url:o}));const h=Array.from(arguments),p=this,f=c[o]&&c[o].isOpen,g=f&&c[o].activeType==2;if(f){if(g){if(typeof h[0]=="string")h[0]="//"+c[o].mockUrl;else if(h[0]instanceof Request){const y=new Request("//"+c[o].mockUrl,{method:h[0].method,headers:h[0].headers,body:h[0].body,mode:h[0].mode,credentials:h[0].credentials,cache:h[0].cache,redirect:h[0].redirect,referrer:h[0].referrer,integrity:h[0].integrity,keepalive:h[0].keepalive,signal:h[0].signal});h[0]=y}b({url:o,mockUrl:c[o].mockUrl})}S(o,w)}const m=P.apply(p,h);return new Promise((y,X)=>{if(f&&!g){const v=c[o].data;c[o].isWaitResponse?m.then(k=>{const T=k.clone();return k.ok&&a[o]&&T.text().then(U=>{d({url:o,data:U,status:k.status})}),k.text().then(()=>{y(new Response(v,{status:200})),b({url:o,mockData:v})})}).catch(()=>{y(new Response(v,{status:200}))}).finally(()=>{o&&a[o]&&R(o,r,i)&&(q({requestListData:a,rules:r,excludeRules:i,sdkLoaded:w}),setTimeout(()=>{delete a[o]},10))}):(y(new Response(v,{status:200})),b({url:o,mockData:v}),m.then(k=>{const T=k.clone();k.ok&&a[o]&&T.text().then(U=>{d({url:o,data:U,status:k.status})})}).finally(()=>{o&&a[o]&&R(o,r,i)&&(q({requestListData:a,rules:r,excludeRules:i,sdkLoaded:w}),setTimeout(()=>{delete a[o]},10))}))}else m.then(v=>{const k=v.clone();v.ok&&a[o]&&k.text().then(T=>{d({url:o,data:T,status:v.status})}),y(v)}).catch(X).finally(()=>{o&&a[o]&&R(o,r,i)&&(q({requestListData:a,rules:r,excludeRules:i,sdkLoaded:w}),setTimeout(()=>{delete a[o]},10))})})},console.log("fetch XMLHttpRequest\u91CD\u5199\u6210\u529F")}),se=t=>{window.addEventListener("mock-global-switch",e=>{e.detail?C(t):oe()}),window.addEventListener("mock-interface-switch",e=>{if(e.detail){const{url:s,isOpen:r,deleteAll:l}=e.detail;if(l)for(const i in c)delete c[i];else r?c[s]=Object.assign({},c[s],e.detail):delete c[s]}}),window.addEventListener("mock-sdk-loaded",e=>{e.detail&&(w=!0,setTimeout(()=>{const s=Object.keys(M);if(s.length)for(const r of s)S(r,w);q({requestListData:A,sdkLoaded:!0})},1e3))})};var ne=(t,e,s)=>new Promise((r,l)=>{var i=n=>{try{d(s.next(n))}catch(u){l(u)}},a=n=>{try{d(s.throw(n))}catch(u){l(u)}},d=n=>n.done?r(n.value):Promise.resolve(n.value).then(i,a);d((s=s.apply(t,e)).next())});const re=t=>ne(void 0,null,function*(){return W()!=="pro"&&(localStorage.getItem("mock_tools_all_opened")!=="false"&&(localStorage.setItem("mock_tools_all_opened","true"),yield C(t)),se(t),z(t.mockPanelSdkUrl||"https://unpkg.com/mock-tools@latest/dist/mock-panel-sdk.umd.js")),!0});L.mockInit=re});
